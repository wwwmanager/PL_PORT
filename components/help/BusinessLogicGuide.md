
# Бизнес-логика приложения

Этот документ описывает все ключевые бизнес-процессы и правила, реализованные в системе. Основная часть логики находится в файле `services/mockApi.ts` и `services/api/*.ts`.

## 1. Жизненный цикл Путевого листа (Waybill)

Это самая сложная и центральная бизнес-логика в приложении. Она управляет статусами путевого листа (ПЛ) и всеми связанными с этим побочными эффектами.

-   **Создание ПЛ (`addWaybill`):**
    *   При создании нового ПЛ, если ему присваивается номер бланка, этот бланк автоматически переводится в статус `"reserved"` (Зарезервирован), чтобы его не мог использовать кто-то другой.

-   **Изменение статуса (`changeWaybillStatus`):** Это ключевая функция, управляющая workflow.
    *   **Проведение (`DRAFT` → `POSTED`):**
        *   **Списание топлива с карты:** Если в ПЛ указана заправка (`fuelFilled > 0`), это количество топлива списывается с баланса топливной карты водителя (`fuelCardBalance` в `Employee`). Система проверяет, достаточно ли топлива на карте, и блокирует операцию в случае нехватки.
        *   **Списание бланка:** Бланк, связанный с ПЛ, переводится в статус `"used"` (Использован) и навсегда привязывается к этому ПЛ.
        *   **Начисление износа шин:** Пробег по ПЛ добавляется к пробегу установленных на данном ТС шин (в зависимости от сезона).
        *   **Обновление статуса ТС:** Пробег и остаток топлива ТС (`Vehicle`) обновляются до значений, указанных в этом ПЛ (при условии, что этот ПЛ хронологически последний).
    *   **Корректировка (`POSTED` → `DRAFT`):**
        *   **Возврат топлива на карту:** Если при проведении было списание за заправку, при корректировке это же количество топлива **возвращается** на баланс карты водителя.
        *   **Возврат бланка:** Статус бланка откатывается со статуса `"used"` на `"issued"` (Выдан).
        *   **Откат износа шин:** Начисленный ранее пробег вычитается из карточек шин.
        *   **Запись причины:** В поле `notes` путевого листа добавляется запись о том, кто, когда и по какой причине выполнил корректировку.
    *   **Отмена (`DRAFT` → `CANCELLED`):**
        *   Если бланк был зарезервирован под этот ПЛ, он освобождается и возвращается в статус `"issued"` (Выдан) водителю.

-   **Удаление ПЛ (`deleteWaybill`):**
    *   **Запрет удаления проведенных:** Проведенный (`POSTED`) ПЛ удалить нельзя. Сначала его нужно вернуть в черновики через "Корректировку".
    *   **Обработка бланка:** При удалении черновика система предлагает два варианта: пометить связанный бланк как `"spoiled"` (испорчен) или вернуть его водителю в статусе `"issued"` (Выдан).

## 2. Учет бланков строгой отчетности

Эта логика обеспечивает строгий контроль за движением бланков путевых листов.

-   **Пачки и бланки:** Система оперирует двумя сущностями: `WaybillBlankBatch` (пачка, описывающая диапазон номеров) и `WaybillBlank` (конкретный бланк с номером и статусом).
-   **Материализация (`materializeBatch`):** Администратор сначала создает "пачку" (например, серия "АА" с №1 по №100). Затем операция "материализации" создает в базе 100 отдельных записей для каждого бланка в статусе `"available"` (На складе).
-   **Выдача водителю (`issueBlanksToDriver`):** Бланки со статусом `"available"` можно выдать водителю. При этом их статус меняется на `"issued"` (Выдан), и им присваивается `ownerEmployeeId`.
-   **Списание (`spoilBlank`, `bulkSpoilBlanks`):** Бланки можно списать. Логика списания зависит от прав пользователя (`Capability`):
    *   `blanks.spoil.self`: Водитель может списать только свой бланк (статус `"issued"`).
    *   `blanks.spoil.warehouse`: Кладовщик может списать бланк со склада (статус `"available"`).
    *   `blanks.spoil.override`: Администратор может списать любой бланк, кроме уже использованного в проведенном ПЛ.

## 3. Складской учет и топливо

Эта логика отвечает за движение товаров на складе, особенно топлива.

-   **Движение остатков (`addStockTransaction`):**
    *   При создании документа типа `income` (Приход), остаток (`balance`) соответствующей номенклатуры (`GarageStockItem`) **увеличивается**.
    *   При создании документа типа `expense` (Расход), остаток **уменьшается**. Система проверяет, достаточно ли товара на складе, и блокирует операцию при нехватке.

-   **Пополнение топливных карт (`addStockTransaction` с `expenseReason: 'fuelCardTopUp'`):**
    *   Это особый тип расхода. При его создании остаток топлива на складе **уменьшается**, а баланс топливной карты водителя (`fuelCardBalance`) **увеличивается** на то же количество.

-   **Отмена операций (`deleteStockTransaction`):**
    *   **Логика реверсивна:** При удалении "Прихода" остаток на складе **уменьшается**. При удалении "Расхода" остаток **увеличивается**.
    *   **Отмена пополнения карты:** При удалении документа пополнения карты, остаток топлива на складе **увеличивается**, а баланс карты водителя **уменьшается**. Система проверяет, не уйдет ли баланс карты в минус, и если да — блокирует удаление.

## 4. Расчеты и валидация

-   **Расчет нормативного расхода топлива (`fuelPlanned` в ПЛ):**
    *   Система определяет, является ли дата ПЛ "зимней" или "летней" на основе настроек сезонов (`isWinterDate`).
    *   На основе этого выбирается базовая норма расхода из карточки ТС (`summerRate`/`winterRate`).
    *   Для каждого сегмента маршрута применяются повышающие коэффициенты (городской цикл, прогрев), если они включены в карточке ТС.
    *   Расход по всем сегментам суммируется для получения итогового нормативного расхода.

-   **Цепочка путевых листов (Chain Recalculation):**
    *   При изменении (редактировании) или создании ПЛ система находит все последующие ПЛ в статусе `DRAFT` для этого автомобиля.
    *   **Непрерывность:** Конечные показания (одометр, остаток топлива) текущего ПЛ автоматически переносятся в начальные показания следующего черновика.
    *   **Пересчет:** Следующий черновик пересчитывается (обновляется нормативный расход и конечный остаток) с учетом новых начальных данных. Этот процесс повторяется рекурсивно до конца цепочки черновиков.

## 5. Права доступа (RBAC)

Логика, определяющая, что может делать тот или иной пользователь, реализована в `services/auth.tsx`.

-   **Роли и Права:** Каждому пользователю присваивается `Role` (например, `admin`, `driver`). Каждой роли соответствует набор прав — `Capability` (например, `waybill.create`, `audit.rollback`).
-   **Проверка:** В компонентах используется хук `useAuth()` с функциями `can()` и `hasRole()`.

## 6. Импорт/Экспорт и Аудит

-   **Экспорт (`dumpAllDataForExport`):** Собирает все данные из всех "таблиц" в единый JSON-файл.
-   **Аудит (`auditLog.ts`, `auditBusiness.ts`):**
    *   **Аудит импорта:** Каждая операция импорта подробно логируется.
    *   **Бизнес-аудит:** Ключевые бизнес-события (создание ПЛ, проведение, списание бланка и т.д.) записываются в отдельный журнал.

## 7. Учет износа шин

Система поддерживает учет жизненного цикла автомобильных шин.

*   **Сущность `Tire`:** Хранит информацию о бренде, модели, размере, сезоне (`Summer`, `Winter`, `AllSeason`) и статусе (`InStock`, `Mounted`, `Disposed`).
*   **Методы учета:** В настройках приложения можно выбрать метод учета износа:
    *   **По факту установки (Usage):** Пробег начисляется на все шины, установленные на автомобиль в данный момент, независимо от текущей даты.
    *   **Строго по сезону (Seasonal):** Пробег начисляется только на шины, соответствующие текущему сезону (зимой — на зимние/всесезонные, летом — на летние/всесезонные).
*   **Начисление:** Происходит автоматически при переводе ПЛ в статус `POSTED`. Пробег добавляется в поля `winterMileage` или `summerMileage` карточки шины.

## 8. Пакетная генерация ПЛ

Функция позволяет автоматически создавать множество черновиков ПЛ на основе загруженного HTML-отчета о поездках.

*   **Парсинг:** Система разбирает файл, извлекает поездки и группирует их по датам.
*   **Календарь:** Используется встроенный производственный календарь (5/2 + праздники РФ) для предупреждения о поездках в выходные дни.
*   **Группировка:** Пользователь может выбрать стратегию группировки:
    *   **1 день:** Один ПЛ на каждый день.
    *   **2 дня:** Объединять 2 дня подряд в один ПЛ (если это не разрывает неделю/месяц).
    *   **Неделя:** Один ПЛ на всю неделю (Пн-Вс).
    *   **Месяц:** Один ПЛ на весь месяц.
*   **Разрывы:** Группировка автоматически прерывается при смене месяца или при смене сезона (зима/лето), чтобы обеспечить корректный расчет норм расхода.
